---
title: "Package MCSimMod: Implementing an Exponential Growth/Decay Model"
author: "Dustin Kapraun"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Mathematical Model

A quantity undergoes exponential growth or decay when the rate of change of the quantity is proportional to the amount currently present. So, if $A(t)$ is the amount at time $t$ and $r$ is the exponential rate of change (with units of one over time), then \begin{equation}
  \frac{\textrm{d}}{\textrm{d}t}A(t) = r \cdot A(t).
\end{equation} When $r$ is positive, the process is known as exponential growth, and when $r$ is negative, the process is known as exponential decay.

In order to solve an initial value problem involving an exponential growth or decay differential equation, one needs to specify an initial amount $A_0$ such that $A(0) = A_0$ as well as the exponential rate $r$.

## MCSim Model Specification

We will use the [GNU MCSim](https://www.gnu.org/software/mcsim/) model specification language to implement the exponential model. Recall that this model has a single state variable, $A$, and two parameters, $r$ and $A_0$, the latter of which is an initial condition for the state variable. All of these components of the exponential model can be included in a text file that we refer to as an "MCSim model specification file." The complete MCSim model specification file for the exponential model, `exponential.model`, can be found in the `extdata` subdirectory of the **MCSimMod** package. A complete description of rules and syntax for MCSim model specification files can be found in Section 5 of the [GNU MCSim User's Manual](https://www.gnu.org/software/mcsim/mcsim.html).

The first element of the MCSim model specification file is a listing of the state variables in the ordinary differential equation (ODE) model. We use the text symbol `A` to represent the state variable $A$ in the exponential model.
```{verbatim}
# STATE VARIABLES for the model (for which ODEs are provided).
States = {
    A,        # Amount of substance.
};
```
Note that the `#` character indicates the start of a comment. That is, any text following the `#` character on any line will be ignored when translating the model specification file into machine language. Note also that the the state variables should be provided as a comma-delimited list that begins with `{` and ends with `};` (with a semicolon).

The model specification file can also include a listing of the "output variables" for the model. These are variables for which values can calculated as analytic functions of state variables, "input variables" (which will be described next), and parameters. For the exponential model, we will not include any output variables, so we will use a blank list. (This element of the model specification file could be omitted.)
```{verbatim}
# OUTPUT VARIABLES for the model (which can be obtained at any point in time
# as analytic functions of state variables, input variables, and parameters).
Outputs = {};
```

Another optional element of the model specification file is a listing of the "input variables" for the model. These variables are independent of other variables and can vary in time. For the exponential model, we will not include any input variables. (This element of the model specification file could be omitted.)
```{verbatim}
# INPUT VARIABLES for the model (which are independent of other variables, and
# which may vary in time).
Inputs = {};
```

The next element of the model specification file allows one to name the parameters and to provide default values for those parameters. (Note that the parameter values to be used for specific model simulations can be changed without editing the model specification file.) Recall that the parameters for the exponential model are $A_0$ and $r$, for which we use the text symbols `A0` and `r`, respetively.
```{verbatim}
# PARAMETERS for the model (which are independent of time).
A0 = 1e-6;       # Initial amount.
r = 1.4;         # Exponential rate of change (time^-1).
```

The "Initialize" section is the next element of the model specification file. In this section, the values of any static parameters that need to be calculated (e.g., based on the values of other parameters) can be determined and initial values of the state variables can be provided. Note that this section begins with `Initialize {` and ends with `}` (with no semicolon).
```{verbatim}
# MODEL INITIALIZATION section.
Initialize {
    # Assign an initial value for each state variable.
    A = A0;
}
```

Finally, we have the "Dynamics" section. In this section of the model specification file, the state equations (ODEs) for all state variables should be provided. This section begins with `Dynamics {` and ends with `}` (with no semicolon). For each state variable in the model, the state equation should be provided using `dt` followed by the text symbol for the state variable in parentheses, the `=` symbol, and then a mathematical expression that represents the time rate of change of the state variable.
```{verbatim}
# DYNAMICS section.
Dynamics {
    # Time rate of change of state variable.
    dt(A) = r * A;
}
```

## Solving an Initial Value Problem

Next, we will use the **MCSimMod** package to solve an initial value problem. One might also call this process "peforming a simulation" with the model.

Using the following commands, we create an exponential model using the model specification file `exponential.model` that is included in the **MCSimMod** package, set the model parameters to $A_0 = 100$ and $r = -0.5$, specify the desired output times ($t = 0, 0.1, 0.2, \ldots, 20.0$), and perform a model simulation.
```{r}
exponential = '
States = {A};

Outputs = {Bout, Cout};

Inputs = {Bin, Cin};

A0 = 1e-6;
r = 1.4;

Initialize {
    A = A0;
}

Dynamics {
    Bout = Bin;
    Cout = Cin;
    dt(A) = r * A;
}
End.
'

model = MCSimMod::Model(mString=exponential)
model$loadModel()
model$updateParms(c(A0=100, r=-0.5))
model$updateY0()

times = seq(from=0, to=20, by=0.1)
out = model$runModel(times)
```

The the final command shown above performs a model simulation and stores the simulation results in a "matrix" data structure called `out`. The first five rows of this data structure are shown below. Note that the independent variable, which is $t$ in the case of the exponential model, is always labeled "time" in the output data structure.
```{r, echo=FALSE, results='asis'}
library(knitr)
kable(out[1:5, ], caption="Simulation Results")
```

We can examine the parameter values and initial conditions that were used for this simulation using the following commands. Note that executing the command `model$updateParms(c(A0=100, r=-0.5))` (in the previous block of code) updated the parameter values from those that were provided in the model specification file and that executing the command `model$updateY0()` updated the initial value of the state variable using the updated value of `A0`.
```{r, echo=TRUE}
model$parms
model$Y0
```

Finally, we can create a visual representation of the simulation results. For example, we can plot the amount vs. time using the following command.
```{r, echo=TRUE}
# Plot simulation results.
plot(out[, "time"], out[, "A"], type="l", lty=1, lwd=2,
     xlab="Time (h)", ylab="Amount (g)")
```
